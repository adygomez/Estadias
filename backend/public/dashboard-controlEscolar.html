<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Administrador | Carga de Archivos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="stylesheet" href="/css/chatbot.css">
</head>
<body class="bg-gray-50 min-h-screen font-['Montserrat']">
  <!-- Navbar -->
  <nav class="relative z-10 bg-[#4C0000] w-full py-3">
    <div class="flex items-center justify-between px-4 md:px-6">
      <!-- Logo Section (Left) -->
      <div class="flex items-center space-x-4">
        <a href="/index.html" class="cursor-pointer">
          <div class="bg-white px-4 py-2 rounded-lg shadow-sm hover:bg-gray-100 transition-colors duration-200">
            <img src="/images/logo-cbtis.png" alt="Logo CBTIS 272" class="h-12 w-auto" />
          </div>
        </a>
      </div>
      
      <!-- Navigation Links (Right) -->
      <div class="flex items-center space-x-4 md:space-x-6">
        <a href="/index.html" class="text-white hover:text-gray-200 transition-colors duration-200 font-medium text-sm md:text-base">Inicio</a>
        <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 font-medium text-sm md:text-base">
          Cerrar Sesión
        </button>
      </div>
    </div>
  </nav>

  <!-- Contenido Principal -->
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- Sección: Gestión de Alumnos (copiada desde dashboard admin) -->
    <div class="bg-white rounded-lg shadow-md p-6 md:p-8 mb-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
        <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4 md:mb-0">Consulta de Alumnos</h2>
      </div>

      <!-- Búsqueda -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <input 
          id="searchFolio" 
          type="text" 
          class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#4C0000] focus:border-transparent" 
          placeholder="Buscar por folio"
        >
        <input 
          id="searchApellidos" 
          type="text" 
          class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#4C0000] focus:border-transparent" 
          placeholder="Buscar por apellidos"
        >
        <button 
          id="btnBuscar" 
          class="bg-[#4C0000] hover:bg-[#6a0000] text-white px-6 py-2 rounded-lg transition-colors duration-200 font-semibold"
        >
          Buscar
        </button>
      </div>

      <!-- Tabla -->
      <div class="overflow-x-auto">
        <table class="min-w-full bg-white border border-gray-200 rounded-lg">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider border-b">Folio</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider border-b">Nombre</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider border-b">CURP</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider border-b">Semestre</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider border-b">Grupo</th>
            </tr>
          </thead>
          <tbody id="resultadosTable" class="bg-white divide-y divide-gray-200">
            <!-- Los resultados se cargarán aquí dinámicamente -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Bloque para exportar alumnos registrados -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <div class="flex flex-col items-center space-y-4">
        <h3 class="text-xl font-bold text-gray-800">Exportar Alumnos Registrados</h3>
        <button 
          id="btnExportar" 
          class="bg-yellow-500 hover:bg-yellow-600 text-white px-8 py-3 rounded-lg transition-colors duration-200 font-semibold"
        >
          Exportar a Excel
        </button>
      </div>
    </div>
    <!-- Las secciones de carga de archivos se han removido en esta vista -->
  </div>

  <script>
    // Verificación de autenticación al cargar la página
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = '/login.html';
    } else {
      // Verificar que el token sea válido y el usuario tenga rol de control_escolar o admin
      fetch('/api/auth/verify-control-escolar', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(res => {
        if (!res.ok) {
          // Si es 401, la sesión expiró
          if (res.status === 401) {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            localStorage.removeItem('login');
            alert('Tu sesión ha expirado. Por favor, inicia sesión nuevamente.');
            window.location.href = '/login.html';
            return;
          }
          
          // Si es 403, el usuario no tiene el rol correcto
          if (res.status === 403) {
            return res.json().then(data => {
              localStorage.removeItem('token');
              localStorage.removeItem('user');
              localStorage.removeItem('login');
              alert(data.message || 'Acceso denegado. Solo usuarios con rol de control escolar pueden acceder a esta sección.');
              window.location.href = '/login.html';
            });
          }
        }
      })
      .catch(err => {
        console.error('Error verificando autenticación:', err);
        window.location.href = '/login.html';
      });
    }

    // Función para hacer peticiones autenticadas
    const authenticatedFetch = async (url, options = {}) => {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }

      const isFormData = options.body instanceof FormData;
      const headers = {
        'Authorization': `Bearer ${token}`,
        ...(isFormData ? {} : { 'Content-Type': 'application/json' }),
        ...options.headers
      };

      const response = await fetch(url, {
        ...options,
        headers
      });

      // Solo tratar 401 como sesión expirada, 403 puede ser falta de permisos específicos
      if (response.status === 401) {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        localStorage.removeItem('login');
        alert('Tu sesión ha expirado. Por favor, inicia sesión nuevamente.');
        window.location.href = '/login.html';
        return;
      }
      
      // Para 403, solo retornar la respuesta sin cerrar sesión
      // El código que llama a esta función debe manejar el 403 apropiadamente

      return response;
    };

    // Configurar botón de logout
    function setupLogout() {
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', (e) => {
          e.preventDefault();
          localStorage.removeItem('token');
          localStorage.removeItem('user');
          localStorage.removeItem('login');
          window.location.href = '/login.html';
        });
      }
    }

    // Configurar logout cuando el DOM esté listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupLogout);
    } else {
      setupLogout();
    }
  </script>

  
  <script>
    // BASE_URL detection (igual que en views/dashboard.html)
    const BASE_URL = window.location.origin.includes('localhost')
      ? 'http://localhost:3001'
      : 'https://registro272.onrender.com';

    // Exportar alumnos
    const btnExportar = document.getElementById('btnExportar');
    if (btnExportar) {
      btnExportar.addEventListener('click', () => {
        // Redirigir para descargar el excel (la ruta debe existir en el servidor)
        window.location.href = `${BASE_URL}/api/exportar-excel`;
      });
    }

    // Búsqueda de alumnos usando la API correcta
    async function buscarAlumnos() {
      const folio = document.getElementById('searchFolio')?.value.trim() || '';
      const apellidos = document.getElementById('searchApellidos')?.value.trim() || '';
      const resultadosTable = document.getElementById('resultadosTable');
      if (!resultadosTable) return;

      if (!folio && !apellidos) {
        resultadosTable.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Ingresa al menos un criterio de búsqueda</td></tr>`;
        return;
      }

      resultadosTable.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Buscando...</td></tr>`;

      try {
        const res = await authenticatedFetch(`${BASE_URL}/api/dashboard/alumnos?folio=${folio}&apellidos=${apellidos}`);
        if (!res) return;
        
        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(errorText || 'Error en búsqueda');
        }

        const data = await res.json();
        renderResultados(data || []);
      } catch (err) {
        console.error('Error buscando alumnos:', err);
        resultadosTable.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Error buscando alumnos: ${err.message}</td></tr>`;
      }
    }

    function renderResultados(items) {
      const resultadosTable = document.getElementById('resultadosTable');
      if (!resultadosTable) return;
      
      if (!items.length) {
        resultadosTable.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No se encontraron registros</td></tr>`;
        return;
      }

      resultadosTable.innerHTML = items.map(alumno => {
        const datos = alumno.datos_alumno || {};
        return `
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-3 text-sm text-gray-700">${alumno.folio || ''}</td>
            <td class="px-6 py-3 text-sm text-gray-700">${datos.primer_apellido || ''} ${datos.segundo_apellido || ''} ${datos.nombres || ''}</td>
            <td class="px-6 py-3 text-sm text-gray-700">${datos.curp || ''}</td>
            <td class="px-6 py-3 text-sm text-gray-700">${datos.semestre || ''}</td>
            <td class="px-6 py-3 text-sm text-gray-700">${datos.grupo || ''}</td>
          </tr>
        `;
      }).join('');
    }

    const btnBuscar = document.getElementById('btnBuscar');
    if (btnBuscar) btnBuscar.addEventListener('click', buscarAlumnos);

    // Permitir búsqueda con Enter
    const searchFolio = document.getElementById('searchFolio');
    const searchApellidos = document.getElementById('searchApellidos');
    
    if (searchFolio) {
      searchFolio.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          buscarAlumnos();
        }
      });
    }
    
    if (searchApellidos) {
      searchApellidos.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          buscarAlumnos();
        }
      });
    }
  </script>
  <script src="/js/chatbot.js"></script>
</body>
</html>

